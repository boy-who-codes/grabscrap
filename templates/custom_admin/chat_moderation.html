{% extends 'custom_admin/base.html' %}

{% block page_title %}Chat Moderation{% endblock %}
{% block page_description %}Review flagged messages and moderate chat content{% endblock %}

{% block content %}
<!-- Flagged Messages -->
<div class="card mb-4">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0"><i class="bi bi-flag"></i> Flagged Messages ({{ flagged_messages.count }})</h5>
    </div>
    <div class="card-body">
        {% if flagged_messages %}
            {% for message in flagged_messages %}
                <div class="card mb-3 border-danger">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>{{ message.sender.username }}</strong>
                            <small class="text-muted">in {{ message.room.name|default:"Chat Room" }}</small>
                        </div>
                        <small class="text-muted">{{ message.created_at|date:"M d, Y H:i" }}</small>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light">
                            <strong>Message:</strong><br>
                            {{ message.content }}
                        </div>
                        
                        {% if message.flagged_reason %}
                            <div class="alert alert-warning">
                                <strong>Flagged for:</strong> {{ message.flagged_reason }}
                            </div>
                        {% endif %}
                        
                        <div class="btn-group">
                            <form method="post" action="{% url 'custom_admin:moderate_message' message.id %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="approve">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-check"></i> Approve
                                </button>
                            </form>
                            <form method="post" action="{% url 'custom_admin:moderate_message' message.id %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="warn">
                                <button type="submit" class="btn btn-warning btn-sm">
                                    <i class="bi bi-exclamation-triangle"></i> Warn User
                                </button>
                            </form>
                            <form method="post" action="{% url 'custom_admin:moderate_message' message.id %}" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete">
                                <button type="submit" class="btn btn-danger btn-sm" 
                                        onclick="return confirm('Delete this message permanently?')">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <i class="bi bi-shield-check display-1 text-success"></i>
                <h5 class="mt-3">No flagged messages!</h5>
                <p class="text-muted">All chat messages are clean and appropriate.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Pending Moderations -->
<div class="card">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-clock"></i> Pending Moderations ({{ pending_moderations.count }})</h5>
    </div>
    <div class="card-body">
        {% if pending_moderations %}
            {% for moderation in pending_moderations %}
                <div class="card mb-3 border-warning">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ moderation.get_violation_type_display }}</strong>
                                <small class="text-muted">by {{ moderation.message.sender.username }}</small>
                            </div>
                            <small class="text-muted">{{ moderation.created_at|date:"M d, Y H:i" }}</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light">
                            <strong>Original Message:</strong><br>
                            {{ moderation.message.content }}
                        </div>
                        
                        <div class="alert alert-warning">
                            <strong>Detected Content:</strong><br>
                            {{ moderation.detected_content }}
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-success btn-sm" onclick="reviewModeration('{{ moderation.id }}', 'approve')">
                                <i class="bi bi-check"></i> Approve
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="reviewModeration('{{ moderation.id }}', 'reject')">
                                <i class="bi bi-x"></i> Take Action
                            </button>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <i class="bi bi-check-circle display-1 text-success"></i>
                <h5 class="mt-3">No pending moderations!</h5>
                <p class="text-muted">All automatic flags have been reviewed.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function reviewModeration(moderationId, action) {
    // This would typically make an AJAX call to review the moderation
    console.log(`Reviewing moderation ${moderationId} with action ${action}`);
    // For now, just reload the page
    location.reload();
}
</script>
{% endblock %}
